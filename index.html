<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ğŸ“‹ ÙƒØ´Ù Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
    }

    .container {
      max-width: 900px;
    }

    .week-range {
      background: #fff3cd;
      padding: 10px;
      border-radius: 8px;
      margin-top: 10px;
    }

    .required-star {
      color: red;
      margin-right: 4px;
    }

    #otherServiceInput {
      border: 2px dashed #28a745;
      background-color: #e8f9ee;
      transition: 0.3s ease;
    }

    #otherServiceInput:focus {
      border-color: #218838;
      background-color: #d4f5de;
      box-shadow: 0 0 6px rgba(33, 136, 56, 0.4);
    }
  </style>
</head>

<body class="p-3">
  <div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0">ğŸ“‹  Ø§Ù„Ø®Ø¯Ù…Ø©</h1>
    </div>

    <!-- ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ -->
    <div id="weekSelector" class="card mb-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ§Ø±ÙŠØ®</h5>
          <div>
            <button id="toggleReport" class="btn btn-outline-success">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
          </div>
        </div>
        <div class="row g-3 align-items-end">
          <div class="col-md-6">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ø¨Ø¯Ø§ÙŠØ© <span class="required-star">*</span></label>
            <input type="date" id="weekStart" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">ØªØ§Ø±ÙŠØ® Ù†Ù‡Ø§ÙŠØ© <span class="required-star">*</span></label>
            <input type="date" id="weekEnd" class="form-control" required>
          </div>
        </div>
        <div id="weekInfo" class="week-range mt-3 d-none text-center fw-bold"></div>
      </div>
    </div>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© -->
    <div id="visitFormCard" class="card mb-3">
      <div class="card-body">
        <h5 class="card-title">Ø¥Ø¶Ø§ÙØ© Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h5>
        <form id="visitForm" novalidate>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„ÙŠÙˆÙ… <span class="required-star">*</span></label>
              <input type="date" id="visitDate" class="form-control" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ø§Ø³Ù… <span class="required-star">*</span></label>
              <input type="text" id="familyNames" class="form-control" required>
            </div>

            <div class="col-md-6">
              <label class="form-label">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© <span class="required-star">*</span></label>
              <select id="serviceType" class="form-select mb-2" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
                <option value="Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ">Ù…Ø¯Ø§Ø±Ø³ Ø§Ù„Ø£Ø­Ø¯ Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ</option>
                <option value="Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ">Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ</option>
                <option value="Ø«Ø§Ù†ÙˆÙŠ">Ø«Ø§Ù†ÙˆÙŠ</option>
                <option value="Ø§Ù„Ø´Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ">Ø§Ù„Ø´Ø¨Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠ</option>
                <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
              </select>
            </div>

            <!-- Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰" -->
            <input type="text" id="otherServiceInput" class="form-control mt-2 d-none"
              placeholder="âœï¸ Ø§ÙƒØªØ¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø© Ù‡Ù†Ø§">

            <div class="col-md-6">
              <label class="form-label">Ø§Ù„ØµÙ <span class="required-star">*</span></label>
              <select id="classLevel" class="form-select mb-2" required>
                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„ØµÙ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«">Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹">Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³">Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
                <option value="Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³">Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
              </select>
            </div>

            <div class="col-md-6">
              <label class="form-label">Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ† <span class="required-star">*</span></label>
              <input type="tel" id="phoneNumber" class="form-control" pattern="^[0-9]{11}$" maxlength="11"
                oninput="this.value = this.value.replace(/[^0-9]/g, '')" required>
            </div>
            <div class="col-md-6">
              <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù† <span class="required-star">*</span></label>
              <input type="text" id="address" class="form-control" required>
            </div>
            <div class="col-md-12">
              <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª </label>
              <textarea id="notes" class="form-control" rows="2"></textarea>
            </div>
          </div>
          <button type="submit" class="btn btn-success mt-3" id="addVisit" disabled>Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø©</button>
        </form>
        <div id="successMessage" class="alert alert-success mt-3 d-none text-center">
          âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­
        </div>
      </div>
    </div>

    <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± -->
    <div id="reportCard" class="card mb-3" style="display:none;">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="card-title mb-3">ØªÙ‚Ø±ÙŠØ± Ø²ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©</h5>
          <button id="downloadPdf" class="btn btn-outline-success">ØªØ­Ù…ÙŠÙ„ PDF</button>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-striped" id="reportTable">
            <thead class="table-light">
              <tr>
                <th>Ø§Ù„ÙŠÙˆÙ…</th>
                <th>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</th>
                <th>Ø§Ù„ØµÙ</th>
                <th>Ø§Ù„Ø§Ø³Ù…</th>
                <th>Ø±Ù‚Ù… Ø§Ù„ØªÙ„ÙŠÙÙˆÙ†</th>
                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
              </tr>
            </thead>
            <tbody id="reportBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Ù…ÙƒØªØ¨Ø§Øª PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const weekStartInput = document.getElementById('weekStart');
    const weekEndInput = document.getElementById('weekEnd');
    const weekInfo = document.getElementById('weekInfo');
    const visitForm = document.getElementById('visitForm');
    const addVisitBtn = document.getElementById('addVisit');
    const toggleReportBtn = document.getElementById('toggleReport');
    const reportCard = document.getElementById('reportCard');
    const visitFormCard = document.getElementById('visitFormCard');
    const reportBody = document.getElementById('reportBody');
    const downloadBtn = document.getElementById('downloadPdf');
    const serviceType = document.getElementById('serviceType');
    const classLevel = document.getElementById('classLevel');
    const otherServiceInput = document.getElementById('otherServiceInput');

    // âœ… Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰"
    // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰" Ù…ÙƒØ§Ù† Ø§Ù„ØµÙ
    // âœ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const classLevelDiv = classLevel.closest('.col-md-6');

    // âœ… Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©
    serviceType.addEventListener('change', () => {
      if (serviceType.value === 'Ø£Ø®Ø±Ù‰') {
        // Ø§Ø®ÙÙŠ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØµÙ
        classLevelDiv.classList.add('d-none');
        // Ø®Ù„ÙŠÙ‡ Ù…Ø´ Ù…Ø·Ù„ÙˆØ¨
        classLevel.required = false;

        // Ø£Ø¸Ù‡Ø± Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰"
        otherServiceInput.classList.remove('d-none');
        otherServiceInput.required = true;
      } else {
        // Ø£Ø¸Ù‡Ø± Ø§Ù„ØµÙ ØªØ§Ù†ÙŠ
        classLevelDiv.classList.remove('d-none');
        classLevel.required = true;

        // Ø§Ø®ÙÙŠ Ø­Ù‚Ù„ "Ø£Ø®Ø±Ù‰"
        otherServiceInput.classList.add('d-none');
        otherServiceInput.required = false;
        otherServiceInput.value = '';
      }
    });


    // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙÙˆÙ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©
    serviceType.addEventListener('change', () => {
      const allOptions = [...classLevel.options];
      allOptions.forEach(opt => opt.hidden = false);
      if (serviceType.value.includes('Ø¥Ø¹Ø¯Ø§Ø¯ÙŠ') || serviceType.value.includes('Ø«Ø§Ù†ÙˆÙŠ')) {
        allOptions.forEach((opt, i) => { if (i > 3) opt.hidden = true; });
      }
      classLevel.value = "";
    });

    function getAllVisits() {
      return JSON.parse(localStorage.getItem('visits')) || [];
    }

    function loadVisits(start = null, end = null) {
      const allVisits = getAllVisits();
      reportBody.innerHTML = '';
      const filtered = (start && end)
        ? allVisits.filter(v => {
          const date = new Date(v.date);
          return date >= new Date(start) && date <= new Date(end);
        })
        : allVisits;

      filtered.forEach(v => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
    <td>${v.date || '-'}</td>
    <td>${v.serviceType || '-'}</td>
    <td>${v.classLevel || '-'}</td>
    <td>${v.familyNames || '-'}</td>
    <td>${v.phoneNumber || '-'}</td>
    <td>${v.address || '-'}</td>
    <td>${v.notes || '-'}</td>`;
        reportBody.appendChild(tr);
      });

    }

    function saveWeekAutomatically() {
      const start = weekStartInput.value;
      const end = weekEndInput.value;
      if (start && end) {
        weekInfo.textContent = `Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù…Ù† ${start} Ø¥Ù„Ù‰ ${end}`;
        weekInfo.classList.remove('d-none');
        loadVisits(start, end);
      }
    }

    weekStartInput.addEventListener('change', saveWeekAutomatically);
    weekEndInput.addEventListener('change', saveWeekAutomatically);

    visitForm.addEventListener('input', () => {
      addVisitBtn.disabled = !visitForm.checkValidity();
    });

    // âœ… ÙƒÙˆØ¯ Ø§Ù„Ø­ÙØ¸ (Ù…ØµØ­Ø­ ÙˆÙ…Ø®ØªØµØ±)
    visitForm.addEventListener('submit', e => {
      e.preventDefault();
      if (!visitForm.checkValidity()) return;

      const selectedService =
        serviceType.value === 'Ø£Ø®Ø±Ù‰'
          ? `Ø£Ø®Ø±Ù‰ (${otherServiceInput.value.trim()})`
          : serviceType.value;

      const visit = {
        date: document.getElementById('visitDate').value,
        serviceType: selectedService,
        classLevel: document.getElementById('classLevel').value,
        familyNames: document.getElementById('familyNames').value,
        phoneNumber: document.getElementById('phoneNumber').value,
        address: document.getElementById('address').value,
        notes: document.getElementById('notes').value
      };

      const allVisits = getAllVisits();
      allVisits.push(visit);
      localStorage.setItem('visits', JSON.stringify(allVisits));

      visitForm.reset();
      otherServiceInput.classList.add('d-none');
      addVisitBtn.disabled = true;
      alert('âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ù†Ø¬Ø§Ø­');
    });

    toggleReportBtn.addEventListener('click', () => {
      const start = weekStartInput.value;
      const end = weekEndInput.value;
      const showingReport = reportCard.style.display === 'block';
      if (showingReport) {
        reportCard.style.display = 'none';
        visitFormCard.style.display = 'block';
        weekInfo.classList.add('d-none');
        weekStartInput.value = '';
        weekEndInput.value = '';
        toggleReportBtn.textContent = 'Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
      } else {
        if (!start || !end) {
          alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø®ØªØ± ÙØªØ±Ø© Ø§Ù„ØªØ§Ø±ÙŠØ® Ø£ÙˆÙ„Ø§Ù‹');
          return;
        }
        reportCard.style.display = 'block';
        visitFormCard.style.display = 'none';
        weekInfo.classList.remove('d-none');
        toggleReportBtn.textContent = 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±';
        loadVisits(start, end);
      }
    });

    // âœ… ØªØ­Ù…ÙŠÙ„ PDF
    downloadBtn.addEventListener('click', async () => {
      if (reportCard.style.display === 'none') {
        alert('Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø£ÙˆÙ„Ø§Ù‹');
        return;
      }

      downloadBtn.style.display = 'none';
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', 'a4');
      const cloned = reportCard.cloneNode(true);
      cloned.style.width = '794px';
      cloned.style.position = 'absolute';
      cloned.style.left = '-9999px';
      document.body.appendChild(cloned);

      const canvas = await html2canvas(cloned, { scale: 2 });
      const imgData = canvas.toDataURL('image/png');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();
      const imgProps = pdf.getImageProperties(imgData);
      const imgHeight = (imgProps.height * pageWidth) / imgProps.width;
      let heightLeft = imgHeight;
      let position = 0;

      pdf.addImage(imgData, 'PNG', 0, position, pageWidth, imgHeight);
      heightLeft -= pageHeight;

      while (heightLeft > 0) {
        position = heightLeft - imgHeight;
        pdf.addPage();
        pdf.addImage(imgData, 'PNG', 0, position, pageWidth, imgHeight);
        heightLeft -= pageHeight;
      }

      pdf.save('ØªÙ‚Ø±ÙŠØ±_Ø§Ù„Ø²ÙŠØ§Ø±Ø§Øª.pdf');
      document.body.removeChild(cloned);
      downloadBtn.style.display = 'inline-block';
    });
  </script>
</body>

</html>